name: Announce Push

on:
  push:
    branches: [main]

jobs:
  announce:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Get commit info
        id: commit
        run: |
          MSG=$(git log -1 --pretty=%s | head -c 200)
          echo "message=$MSG" >> $GITHUB_OUTPUT
          FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | head -5 | tr '\n' ' ')
          echo "files=$FILES" >> $GITHUB_OUTPUT
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Tweet announcement
        continue-on-error: true
        env:
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
          COMMIT_MSG: ${{ steps.commit.outputs.message }}
          COMMIT_FILES: ${{ steps.commit.outputs.files }}
          REPO: ${{ github.repository }}
        run: |
          if [ -z "$TWITTER_API_KEY" ]; then
            echo "Skipping - no Twitter credentials"
            exit 0
          fi
          pip install tweepy -q
          python3 -c "
          import tweepy, os, sys

          api_key = os.environ.get('TWITTER_API_KEY', '')
          if not api_key:
              print('No credentials')
              sys.exit(0)

          try:
              client = tweepy.Client(
                  consumer_key=api_key,
                  consumer_secret=os.environ['TWITTER_API_SECRET'],
                  access_token=os.environ['TWITTER_ACCESS_TOKEN'],
                  access_token_secret=os.environ['TWITTER_ACCESS_SECRET']
              )
              msg = os.environ.get('COMMIT_MSG', '')[:150]
              files = os.environ.get('COMMIT_FILES', '')[:60]
              repo = os.environ.get('REPO', '')
              tweet = f'Push to {repo}: {msg}'
              response = client.create_tweet(text=tweet[:280])
              print(f'Tweeted: https://twitter.com/i/status/{response.data[\"id\"]}')
          except Exception as e:
              print(f'Tweet failed: {e}')
          "
