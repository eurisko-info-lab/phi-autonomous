-- ═══════════════════════════════════════════════════════════════════════════
-- credentials.phi - Secure Credential Management
-- ═══════════════════════════════════════════════════════════════════════════
--
-- SECURITY: Credentials are NEVER stored in source code or specs.
-- They are loaded at runtime from secure sources only.
--
-- Hierarchy (first found wins):
--   1. System keyring (macOS Keychain, Linux Secret Service, Windows Credential Manager)
--   2. Environment variables
--   3. .env file (gitignored, local only)
--
-- ═══════════════════════════════════════════════════════════════════════════

module Credentials where

import RVM.FFI.Env (getEnv, loadDotEnv)
import RVM.FFI.Keyring (getSecret)

-- ┌─────────────────────────────────────────────────────────────────────────┐
-- │                    CREDENTIAL TYPES                                      │
-- └─────────────────────────────────────────────────────────────────────────┘

-- Opaque wrapper - cannot be printed or serialized
newtype Secret a = Secret { unSecret : a }

instance Show (Secret a) where
  show _ = "Secret(***)"

-- No ToJSON instance - secrets cannot be serialized!
-- No Debug instance - secrets cannot be logged!

-- Credential sources (in priority order)
data CredentialSource
  = Keyring String           -- system keyring, service name
  | EnvVar String            -- environment variable
  | DotEnv FilePath String   -- .env file, key name
  deriving (Eq, Show)


-- ┌─────────────────────────────────────────────────────────────────────────┐
-- │                    PLATFORM CREDENTIALS                                  │
-- └─────────────────────────────────────────────────────────────────────────┘

-- Twitter/X OAuth 2.0
data TwitterCreds where
  TwitterCreds : {
    clientId     : Secret String,
    clientSecret : Secret String,
    accessToken  : Secret String,
    refreshToken : Secret String
  } -> TwitterCreds

-- Bluesky AT Protocol
data BluskyCreds where
  BluskyCreds : {
    handle      : String,        -- public, e.g. "phi.bsky.social"
    did         : String,        -- public, e.g. "did:plc:..."
    accessJwt   : Secret String,
    refreshJwt  : Secret String
  } -> BluskyCreds

-- Discord webhook (stateless, just URL)
data DiscordCreds where
  DiscordCreds : {
    webhookUrl : Secret String   -- contains token in URL
  } -> DiscordCreds

-- GitHub Personal Access Token
data GitHubCreds where
  GitHubCreds : {
    token : Secret String        -- PAT or fine-grained token
  } -> GitHubCreds

-- Anthropic API
data AnthropicCreds where
  AnthropicCreds : {
    apiKey : Secret String
  } -> AnthropicCreds


-- ┌─────────────────────────────────────────────────────────────────────────┐
-- │                    CREDENTIAL LOADING                                    │
-- └─────────────────────────────────────────────────────────────────────────┘

-- Load a secret from the first available source
loadSecret : [CredentialSource] -> IO (Maybe (Secret String))
loadSecret [] = pure Nothing
loadSecret (src : rest) = do
  result <- trySource src
  case result of
    Just s  -> pure (Just (Secret s))
    Nothing -> loadSecret rest

trySource : CredentialSource -> IO (Maybe String)
trySource (Keyring service) = getSecret "phi-autonomous" service
trySource (EnvVar name) = getEnv name
trySource (DotEnv path key) = do
  loadDotEnv path
  getEnv key


-- Load Twitter credentials
loadTwitterCreds : IO (Either String TwitterCreds)
loadTwitterCreds = do
  clientId <- loadSecret [
    Keyring "twitter-client-id",
    EnvVar "TWITTER_CLIENT_ID",
    DotEnv ".env" "TWITTER_CLIENT_ID"
  ]
  clientSecret <- loadSecret [
    Keyring "twitter-client-secret",
    EnvVar "TWITTER_CLIENT_SECRET",
    DotEnv ".env" "TWITTER_CLIENT_SECRET"
  ]
  accessToken <- loadSecret [
    Keyring "twitter-access-token",
    EnvVar "TWITTER_ACCESS_TOKEN",
    DotEnv ".env" "TWITTER_ACCESS_TOKEN"
  ]
  refreshToken <- loadSecret [
    Keyring "twitter-refresh-token",
    EnvVar "TWITTER_REFRESH_TOKEN",
    DotEnv ".env" "TWITTER_REFRESH_TOKEN"
  ]
  
  case (clientId, clientSecret, accessToken, refreshToken) of
    (Just ci, Just cs, Just at, Just rt) ->
      pure $ Right $ TwitterCreds ci cs at rt
    _ ->
      pure $ Left "Missing Twitter credentials. Set TWITTER_* env vars or use keyring."


-- Load Bluesky credentials
loadBluskyCreds : IO (Either String BluskyCreds)
loadBluskyCreds = do
  handle <- getEnv "BLUESKY_HANDLE"
  did <- getEnv "BLUESKY_DID"
  accessJwt <- loadSecret [
    Keyring "bluesky-access-jwt",
    EnvVar "BLUESKY_ACCESS_JWT",
    DotEnv ".env" "BLUESKY_ACCESS_JWT"
  ]
  refreshJwt <- loadSecret [
    Keyring "bluesky-refresh-jwt",
    EnvVar "BLUESKY_REFRESH_JWT",
    DotEnv ".env" "BLUESKY_REFRESH_JWT"
  ]
  
  case (handle, did, accessJwt, refreshJwt) of
    (Just h, Just d, Just aj, Just rj) ->
      pure $ Right $ BluskyCreds h d aj rj
    _ ->
      pure $ Left "Missing Bluesky credentials."


-- Load Discord credentials
loadDiscordCreds : IO (Either String DiscordCreds)
loadDiscordCreds = do
  webhookUrl <- loadSecret [
    Keyring "discord-webhook-url",
    EnvVar "DISCORD_WEBHOOK_URL",
    DotEnv ".env" "DISCORD_WEBHOOK_URL"
  ]
  case webhookUrl of
    Just url -> pure $ Right $ DiscordCreds url
    Nothing  -> pure $ Left "Missing DISCORD_WEBHOOK_URL"


-- Load GitHub credentials  
loadGitHubCreds : IO (Either String GitHubCreds)
loadGitHubCreds = do
  token <- loadSecret [
    Keyring "github-token",
    EnvVar "GITHUB_TOKEN",
    DotEnv ".env" "GITHUB_TOKEN"
  ]
  case token of
    Just t  -> pure $ Right $ GitHubCreds t
    Nothing -> pure $ Left "Missing GITHUB_TOKEN"


-- Load Anthropic credentials
loadAnthropicCreds : IO (Either String AnthropicCreds)
loadAnthropicCreds = do
  key <- loadSecret [
    Keyring "anthropic-api-key",
    EnvVar "ANTHROPIC_API_KEY",
    DotEnv ".env" "ANTHROPIC_API_KEY"
  ]
  case key of
    Just k  -> pure $ Right $ AnthropicCreds k
    Nothing -> pure $ Left "Missing ANTHROPIC_API_KEY"


-- ┌─────────────────────────────────────────────────────────────────────────┐
-- │                    SECURITY INVARIANTS                                   │
-- └─────────────────────────────────────────────────────────────────────────┘

-- These are enforced by the type system:
--
-- 1. Secret values cannot be printed (no Show instance exposes value)
-- 2. Secret values cannot be serialized (no ToJSON/Serialize instance)
-- 3. Secret values cannot be logged (no Debug instance)
-- 4. Secret values can only be used via dedicated API functions
--
-- Example: To use a token in an HTTP header, you must use:
--   withSecret : Secret String -> (String -> IO a) -> IO a
--
-- This ensures the secret is used ephemerally and not stored.

withSecret : Secret a -> (a -> IO b) -> IO b
withSecret (Secret s) f = f s

-- ═══════════════════════════════════════════════════════════════════════════
-- .gitignore MUST include:
--   .env
--   *.secret
--   credentials.json
--   .credentials/
-- ═══════════════════════════════════════════════════════════════════════════
